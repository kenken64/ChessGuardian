<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Guardian — Live Game</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .live-container { max-width: 520px; margin: 0 auto; padding: 1rem; }
        .live-header { text-align: center; margin-bottom: 1rem; }
        .live-header h1 { font-size: 1.4rem; margin: 0; }
        .live-header .game-id { color: #888; font-size: 0.85rem; }
        .live-status { text-align: center; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; font-weight: 600; }
        .live-status.active { background: #e8f5e9; color: #2e7d32; }
        .live-status.over { background: #fff3e0; color: #e65100; }
        .live-board { margin: 0 auto; }
        .win-gauge { height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 0.75rem 0; }
        .win-gauge-fill { height: 100%; background: linear-gradient(90deg, #fff 0%, #fff 100%); transition: width 0.5s; }
        .win-gauge-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; }
        .move-list { max-height: 200px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e0e0e0; }
        .move-list .move-pair { margin-bottom: 2px; }
        .move-list .move-num { color: #888; margin-right: 0.5em; }
    </style>
</head>
<body>
<div class="live-container">
    <div class="live-header">
        <h1>♟ Chess Guardian — Live</h1>
        <div class="game-id">Game {{ game_id }}</div>
    </div>

    <div id="statusBar" class="live-status active">Loading...</div>

    <div class="win-gauge-label"><span>Black</span><span id="winLabel">50%</span><span>White</span></div>
    <div class="win-gauge"><div id="winFill" class="win-gauge-fill" style="width:50%"></div></div>

    <div id="board" class="live-board" style="width:100%"></div>

    <div id="moveList" class="move-list"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script>
const GAME_ID = "{{ game_id }}";
let board = Chessboard('board', {
    orientation: 'black',
    draggable: false,
    pieceTheme: 'https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/img/chesspieces/wikipedia/{piece}.png'
});

let lastHistoryLen = 0;

function renderMoves(history) {
    let html = '';
    for (let i = 0; i < history.length; i += 2) {
        const num = Math.floor(i / 2) + 1;
        const w = history[i] || '';
        const b = history[i + 1] || '';
        html += `<div class="move-pair"><span class="move-num">${num}.</span>${w} ${b}</div>`;
    }
    document.getElementById('moveList').innerHTML = html;
    const el = document.getElementById('moveList');
    el.scrollTop = el.scrollHeight;
}

function poll() {
    fetch(`/api/live/${GAME_ID}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('statusBar').textContent = data.error;
                document.getElementById('statusBar').className = 'live-status over';
                return;
            }

            board.position(data.fen);
            renderMoves(data.history);

            const bar = document.getElementById('statusBar');
            if (data.gameOver) {
                bar.textContent = `Game Over — ${data.status}${data.result ? ' (' + data.result + ')' : ''}`;
                bar.className = 'live-status over';
            } else {
                // If history length is odd, it's Black's turn
                const blackTurn = data.history.length % 2 === 1;
                bar.textContent = blackTurn ? "Waiting for Black's move..." : "AI thinking...";
                bar.className = 'live-status active';
            }

            lastHistoryLen = data.history.length;
        })
        .catch(() => {});
}

poll();
setInterval(poll, 3000);

$(window).resize(() => board.resize());
</script>
</body>
</html>
