<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Guardian â€” Live Game</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .live-container { max-width: 520px; margin: 0 auto; padding: 1rem; }
        .live-header { text-align: center; margin-bottom: 1rem; }
        .live-header h1 { font-size: 1.4rem; margin: 0; }
        .live-header .game-id { color: #888; font-size: 0.85rem; }
        .live-status { text-align: center; padding: 0.5rem; margin: 0.5rem 0; border-radius: 6px; font-weight: 600; }
        .live-status.active { background: #e8f5e9; color: #2e7d32; }
        .live-status.over { background: #fff3e0; color: #e65100; }
        .live-board { margin: 0 auto; }
        .win-gauge { height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 0.75rem 0; }
        .win-gauge-fill { height: 100%; background: linear-gradient(90deg, #fff 0%, #fff 100%); transition: width 0.5s; }
        .win-gauge-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; }
        .move-list { max-height: 200px; overflow-y: auto; background: #1a1a2e; border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; font-family: monospace; font-size: 0.85rem; color: #e0e0e0; }
        .move-list .move-pair { margin-bottom: 2px; }
        .move-list .move-num { color: #888; margin-right: 0.5em; }
        .player-label { display: flex; align-items: center; gap: 0.4em; padding: 0.4rem 0.6rem; border-radius: 6px; font-size: 0.9rem; font-weight: 500; background: #1a1a2e; color: #e0e0e0; }
        .player-label.active-turn { background: #2e7d32; color: #fff; }
        .player-labels { display: none; margin: 0.5rem 0; }
    </style>
</head>
<body>
<div class="live-container">
    <div class="live-header">
        <h1>â™Ÿ Chess Guardian â€” Live</h1>
        <div class="game-id">Game {{ game_id }}</div>
    </div>

    <div id="statusBar" class="live-status active">Loading...</div>

    <div class="win-gauge-label"><span>Black</span><span id="winLabel">50%</span><span>White</span></div>
    <div class="win-gauge"><div id="winFill" class="win-gauge-fill" style="width:50%"></div></div>

    <div id="playerLabels" class="player-labels">
        <div id="topPlayer" class="player-label"></div>
    </div>

    <div id="board" class="live-board" style="width:100%"></div>

    <div id="playerLabelsBottom" class="player-labels">
        <div id="bottomPlayer" class="player-label"></div>
    </div>

    <div id="moveList" class="move-list"></div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script>
const GAME_ID = "{{ game_id }}";
const urlParams = new URLSearchParams(window.location.search);
const orientation = urlParams.get('orientation') || 'white';

let board = Chessboard('board', {
    orientation: orientation,
    draggable: false,
    pieceTheme: 'https://raw.githubusercontent.com/oakmac/chessboardjs/master/website/img/chesspieces/wikipedia/{piece}.png'
});

let lastHistoryLen = 0;

function renderMoves(history) {
    let html = '';
    for (let i = 0; i < history.length; i += 2) {
        const num = Math.floor(i / 2) + 1;
        const w = history[i] || '';
        const b = history[i + 1] || '';
        html += `<div class="move-pair"><span class="move-num">${num}.</span>${w} ${b}</div>`;
    }
    document.getElementById('moveList').innerHTML = html;
    const el = document.getElementById('moveList');
    el.scrollTop = el.scrollHeight;
}

function renderPlayerLabels(data) {
    if (data.mode !== 'pvp') {
        document.getElementById('playerLabels').style.display = 'none';
        document.getElementById('playerLabelsBottom').style.display = 'none';
        return;
    }

    document.getElementById('playerLabels').style.display = 'block';
    document.getElementById('playerLabelsBottom').style.display = 'block';

    const whiteTurn = data.turn === 'white' && !data.gameOver;
    const blackTurn = data.turn === 'black' && !data.gameOver;

    const whiteLabel = `<span>&#9898; ${data.whitePlayer || 'White'}</span>`;
    const blackLabel = `<span>&#9899; ${data.blackPlayer || 'Black'}</span>`;

    const topEl = document.getElementById('topPlayer');
    const bottomEl = document.getElementById('bottomPlayer');

    if (orientation === 'white') {
        topEl.innerHTML = blackLabel;
        topEl.className = 'player-label' + (blackTurn ? ' active-turn' : '');
        bottomEl.innerHTML = whiteLabel;
        bottomEl.className = 'player-label' + (whiteTurn ? ' active-turn' : '');
    } else {
        topEl.innerHTML = whiteLabel;
        topEl.className = 'player-label' + (whiteTurn ? ' active-turn' : '');
        bottomEl.innerHTML = blackLabel;
        bottomEl.className = 'player-label' + (blackTurn ? ' active-turn' : '');
    }
}

function poll() {
    fetch(`/api/live/${GAME_ID}`)
        .then(r => r.json())
        .then(data => {
            if (data.error) {
                document.getElementById('statusBar').textContent = data.error;
                document.getElementById('statusBar').className = 'live-status over';
                return;
            }

            board.position(data.fen);
            renderMoves(data.history);
            renderPlayerLabels(data);

            const bar = document.getElementById('statusBar');
            if (data.gameOver) {
                let msg = 'Game Over';
                if (data.status === 'resigned') {
                    msg = data.result === '1-0' ? 'ðŸ³ï¸ Black resigned â€” White wins!' : 'ðŸ³ï¸ White resigned â€” Black wins!';
                } else if (data.status === 'checkmate') {
                    msg = data.result === '1-0' ? 'â™” Checkmate â€” White wins!' : 'â™š Checkmate â€” Black wins!';
                } else if (data.status === 'draw') {
                    msg = 'ðŸ¤ Draw';
                } else {
                    msg = `Game Over â€” ${data.status}${data.result ? ' (' + data.result + ')' : ''}`;
                }
                bar.textContent = msg;
                bar.className = 'live-status over';
                clearInterval(pollInterval);
            } else if (data.mode === 'pvp') {
                bar.textContent = data.turn === 'white' ? "White's turn" : "Black's turn";
                bar.className = 'live-status active';
            } else {
                const blackTurn = data.history.length % 2 === 1;
                bar.textContent = blackTurn ? "Waiting for Black's move..." : "AI thinking...";
                bar.className = 'live-status active';
            }

            lastHistoryLen = data.history.length;
        })
        .catch(() => {});
}

poll();
const pollInterval = setInterval(poll, 3000);

$(window).resize(() => board.resize());
</script>
</body>
</html>
